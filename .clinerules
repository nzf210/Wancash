# Wancash Staking Project - Development Rules

## üéØ Core Architecture & Principles

The Wancash Staking project is a multi-layered decentralized application:

1.  **Frontend**: Vue 3 (Composition API) + Pinia + Tailwind CSS.
2.  **Backend**: Cloudflare Workers (Hono/TypeScript) + Neon DB (PostgreSQL).
3.  **Smart Contracts**: Hardhat/Solidity + LayerZero V2 for cross-chain bridging.

### 1. Planning Before Execution (MANDATORY)

- **ALWAYS** create an `implementation_plan.md` artifact for complex changes.
- **ALWAYS** get user approval via `notify_user` before making code changes.
- Break down work into clear, reviewable steps in `task.md`.

---

## üíæ Data Structure & State Management

### 1. Database Migrations (Neon DB)

- **Baseline**: `migrations/000_baseline_schema.sql` contains the project's initial manual schema.
- **Workflow**:
  1. Create a new `.sql` file in `cloude-flare-wancash/migrations/` using incremental numbering (e.g., `013_new_feature.sql`).
  2. Use `IF NOT EXISTS` for tables and `ADD COLUMN IF NOT EXISTS` for column additions.
  3. **Application**: Use `bun run scripts/apply-migrations.ts` to apply ALL pending migrations. This script tracks applied migrations in the `_migrations` table.
  4. **IMPORTANT**: If you create a new migration manually, ensure you add it to `migrations/` and running the script.
- **Mocking**: When testing, use `vi.mock('@neondatabase/serverless')`.

### 2. State & Variable Management

- **Global Variables**: **ALWAYS** trace usage using `grep_search` before modification.
- **Frontend State**: Use Pinia stores for global app state and Composables for reusable logic.
- **Consistency**: Ensure TypeScript interfaces match the backend database schema and API responses.

---

## üåç Environment & Configuration

### 1. Environment Synchronization

- **Single Source of Truth**: The root `.env` file.
- **Worker Env**: Use `my-frontend/cloude-flare-wancash/scripts/generate-env-only.ts` to sync `.env` to `.dev.vars` and generate `src/env.d.ts`.
- **Command**: Run the sync script after adding any new environment variable.

### 2. API & Network Configuration

- **Wrangler**: Update `wrangler.jsonc` for new bindings (Rate limiters, KV, etc.).
- **Vite**: Ensure frontend `.env` matches the backend RPC and contract addresses.

---

## üöÄ Feature Implementation Workflow (AI-TDD)

Follow the **"Spec First, Test Second, Code Third"** principle:

1.  **Spec-First**: Request or define TypeScript Interfaces/Types and list all test scenarios (Happy & Sad paths).
2.  **Generate Tests (Red)**: Create `.spec.ts` in `test/` (e.g., `my-frontend/cloude-flare-wancash/test/`) before implementation.
3.  **Implement (Green)**: Write the minimum code to pass the tests.
4.  **Refactor**: Optimize once tests pass.
5.  **Service Layer**: Update `src/app/services/` in the frontend to match new backend endpoints.

---

## üîî Notification & Error Systems

### 1. Telegram Alert Mapping

- `TELEGRAM_CHAT_ID_ERROR`: System errors and exceptions.
- `TELEGRAM_CHAT_ID_REDEMPTION`: Redemption request updates (pending -> processing -> etc.).
- `TELEGRAM_CHAT_ID_BRIDGE`: LayerZero bridge transaction events.
- `TELEGRAM_CHAT_ID_SEND_TRX`: Send token transaction events.

### 2. Explorer Links

- Use chain-specific explorer URLs (`EXPLORER_URL_SEPOLIA`, `LZ_SCAN_URL`, etc.) in notification messages.

---

## üß™ Testing Protocol

### 1. Cloudflare Workers

- **Framework**: Vitest + `@cloudflare/vitest-pool-workers`.
- **Command**: `bun run test` (Always use Bun).
- **Mocks**: Mock `Client` from `@neondatabase/serverless` and JWT verification using `jose`.

### 2. Smart Contracts

- **Framework**: Hardhat.
- **Context**: Check `my-ofts/hardhat.config.ts` for network settings.
- **Tooling**: Use LayerZero CLI for cross-chain testing.

---

## üìÅ Folder Structure Enforcement

### Frontend (`my-frontend/src`)

- `app/components/`: Core shared components.
- `app/composables/`: Reusable logic (e.g., `useAuth.ts`, `useWallet.ts`).
- `app/services/`: API communication layer.
- `modules/`: Feature-specific logic (e.g., `redemption/`, `bridge/`).

### Backend (`my-frontend/cloude-flare-wancash/src`)

- `index.ts`: Entry point & CORS.
- `auth.ts`, `db.ts`, `metrics.ts`: Modular backend logic.
- `migrations/`: SQL migration files.

### Contracts (`my-ofts/contracts`)

- Keep logic in `contracts/` and deployment scripts in `deploy/`.

---

## ‚ö†Ô∏è Pre-Change Checklist

1. üîç **Search** all usages (Variable/Endpoint).
2. üìã **Plan** via `implementation_plan.md`.
3. ‚úÖ **Approve** via `notify_user`.
4. üõ†Ô∏è **Implement** incrementally.
5. ‚ú® **Verify** via tests and `walkthrough.md`.

---

_Last updated: 2026-01-15 - Synchronized with Baseline Migration 000_
