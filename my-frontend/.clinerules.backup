# Wancash Staking Project - Development Rules

## ğŸ¯ Core Principles

### 1. Variable & State Management

- **ALWAYS** check and trace variable usage before making changes to global variables
- Search for all references using `grep_search` or `find_by_name`
- Document all affected components/files
- Verify state management patterns (Pinia stores, composables, reactive refs)

**Example checklist:**

```
[ ] Search for variable usage across codebase
[ ] Identify all consumers (components, composables, stores)
[ ] Check if variable is used in computed properties
[ ] Verify reactive dependencies
[ ] Update all references consistently
```

### 2. Backend API Endpoint Changes

- **ALWAYS** identify all consumers before modifying any BE endpoint
- Check both frontend and backend for endpoint usage
- Verify request/response contract compatibility
- Ensure synchronization between FE and BE

**Required checks:**

```
[ ] Search for endpoint usage in frontend (fetch, axios calls)
[ ] Check API route definitions in backend
[ ] Verify request payload structure
[ ] Verify response structure
[ ] Check error handling on both sides
[ ] Update TypeScript types if needed
[ ] Test all affected consumers
```

### 3. Planning Before Execution

- **ALWAYS** create an implementation plan before making changes
- Use `implementation_plan.md` artifact for complex changes
- Get user approval before proceeding with implementation
- Break down work into clear, reviewable steps

**Planning template:**

```markdown
# [Feature/Fix Name]

## Problem

[Clear description of the issue or requirement]

## Proposed Changes

### Component 1

- Change A
- Change B

### Component 2

- Change C

## Affected Areas

- [ ] Frontend components: [list]
- [ ] Backend endpoints: [list]
- [ ] Global state: [list]
- [ ] Types/Interfaces: [list]

## Verification Plan

- [ ] Test case 1
- [ ] Test case 2
```

---

## ğŸ“ Project Structure

### Frontend (`/my-frontend`)

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ components/     # Shared components
â”‚   â”œâ”€â”€ composables/    # Vue composables (useAuth, etc)
â”‚   â””â”€â”€ router/         # Vue Router config
â”œâ”€â”€ modules/            # Feature modules
â”œâ”€â”€ stores/             # Pinia stores
â””â”€â”€ utils/              # Utility functions
```

### Backend (`/cloude-flare-wancash`)

- Cloudflare Workers
- API endpoints
- Database migrations

---

## ğŸ” Pre-Change Checklist

Before making ANY code change:

### For Variable Changes:

1. âœ… Search for all usages: `grep_search` with variable name
2. âœ… Check if it's a global state (Pinia store, composable)
3. âœ… Identify all consumers (components, other composables)
4. âœ… Verify reactive dependencies
5. âœ… Plan updates for all affected files

### For API Endpoint Changes:

1. âœ… Search frontend for endpoint usage: `grep_search` with endpoint path
2. âœ… Check backend route handler
3. âœ… Verify request/response types match
4. âœ… Check error handling on both sides
5. âœ… List all consumers that need updates
6. âœ… Plan synchronization strategy

### For Component Changes:

1. âœ… Check if component is used in multiple places
2. âœ… Verify props/emits contracts
3. âœ… Check parent-child dependencies
4. âœ… Test responsive design (mobile/desktop)

---

## ğŸš€ Development Workflow

### Step 1: Analysis

- Understand the requirement fully
- Ask clarifying questions if needed
- Identify all affected areas
- if add devendency chek existing dev to syncronising

### Step 2: Planning

- Create `implementation_plan.md`
- List all files to be changed
- Identify potential risks
- Get user approval via `notify_user`

### Step 3: Implementation

- Make changes incrementally
- Follow the plan
- Update related files together
- Keep changes atomic and focused

### Step 4: Verification

- Test all affected functionality
- Verify no regressions
- Check console for errors
- Create `walkthrough.md` with results

---

## ğŸ› ï¸ Technology Stack

### Frontend

- **Framework**: Vue 3 (Composition API)
- **State**: Pinia stores + Composables
- **Router**: Vue Router
- **Wallet**: Wagmi + Web3Modal
- **UI**: Custom components + Tailwind CSS
- **Build**: Vite + Bun

### Backend

- **Platform**: Cloudflare Workers
- **Database**: D1 (SQLite)
- **Auth**: Cookie-based with JWT

---

## âš ï¸ Common Pitfalls to Avoid

1. **Don't** modify global variables without checking all usages
2. **Don't** change API contracts without updating all consumers
3. **Don't** skip the planning phase for complex changes
4. **Don't** make assumptions - always verify with grep/search
5. **Don't** forget to check both FE and BE when changing endpoints

---

## ğŸ“ Code Style Guidelines

### TypeScript

- Use explicit types for function parameters and returns
- Prefer `interface` over `type` for object shapes
- Use `const` for immutable values
- Use descriptive variable names
- use bun

### Vue Components

- Use Composition API with `<script setup>`
- Keep components focused and single-purpose
- Extract reusable logic to composables
- Use TypeScript for props and emits

### Naming Conventions

- Components: PascalCase (e.g., `UserProfile.vue`)
- Composables: camelCase with `use` prefix (e.g., `useAuth.ts`)
- Stores: camelCase with `Store` suffix (e.g., `userStore.ts`)
- Constants: UPPER_SNAKE_CASE

---

## ğŸ” Authentication Flow

Current implementation uses:

- Wagmi for wallet connection
- Cookie-based sessions (HttpOnly)
- Access tokens (4 min) + Refresh tokens (7 days)
- Proactive token refresh (1 min before expiry)
- Role-based access (user/admin)

**Key files:**

- `/src/app/composables/useAuth.ts` - Main auth logic
- `/src/app/router/index.ts` - Route guards
- Backend: `/cloude-flare-wancash/src/index.ts`

---

## ğŸ“‹ Example: Changing a Global Variable

```typescript
// âŒ WRONG - Direct change without checking
const isConnected = ref(false) // Changed from true

// âœ… CORRECT - Follow the process
// 1. Search for all usages
grep_search('isConnected', '*.ts', '*.vue')

// 2. Document findings
// Found in:
// - useAuth.ts (definition)
// - Header.vue (displays connection status)
// - WalletButton.vue (enables/disables button)

// 3. Create plan
// - Update useAuth.ts logic
// - Verify Header.vue still works
// - Verify WalletButton.vue still works
// - Test connection flow

// 4. Get approval, then implement
```

---

## ğŸ“‹ Example: Changing an API Endpoint

```typescript
// Changing: POST /api/auth/verify

// âœ… CORRECT Process:
// 1. Search frontend usage
grep_search('/api/auth/verify', '*.ts', '*.vue')
// Found in: useAuth.ts line 186

// 2. Check backend handler
// File: cloude-flare-wancash/src/auth.ts

// 3. Document contract
// Request: { address, signature, message, chainId }
// Response: { user, expiresIn }

// 4. Plan changes
// - Update backend handler
// - Update frontend call in useAuth.ts
// - Update TypeScript types
// - Test login flow

// 5. Get approval, implement, verify
```

---

## ğŸ¯ Remember

> **"Plan first, code second, verify always"**

Every change should follow this pattern:

1. ğŸ” **Search** - Find all affected code
2. ğŸ“‹ **Plan** - Document what will change
3. âœ… **Approve** - Get user confirmation
4. ğŸ› ï¸ **Implement** - Make the changes
5. âœ¨ **Verify** - Test everything works

---

_Last updated: 2026-01-12_
