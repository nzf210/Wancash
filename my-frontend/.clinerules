# Wancash Staking Project - Development Rules

## ğŸ¯ Core Principles

### 1. Variable & State Management

- **ALWAYS** check and trace variable usage before making changes to global variables
- Search for all references using `grep_search` or `find_by_name`
- Document all affected components/files
- Verify state management patterns (Pinia stores, composables, reactive refs)

**Example checklist:**

```
[**] Search for variable usage across codebase
[**] Identify all consumers (components, composables, stores)
[**] Check if variable is used in computed properties
[] Verify reactive dependencies
[**] Update all references consistently
```

### 2. Backend API Endpoint Changes

- **ALWAYS** identify all consumers before modifying any BE endpoint
- Check both frontend and backend for endpoint usage
- Verify request/response contract compatibility
- Ensure synchronization between FE and BE

**Required checks:**

```
[**] Search for endpoint usage in frontend (fetch, axios calls)
[**] Check API route definitions in backend
[**] Verify request payload structure
[**] Verify response structure
[**] Check error handling on both sides
[**] Update TypeScript types if needed
[**] Test all affected consumers
```

### 3. Planning Before Execution

- **ALWAYS** create an implementation plan before making changes
- Use `implementation_plan.md` artifact for complex changes
- Get user approval before proceeding with implementation
- Break down work into clear, reviewable steps

**Planning template:**

```markdown
# [Feature/Fix Name]

## Problem

[Clear description of the issue or requirement]

## Proposed Changes

### Component 1

- Change A
- Change B

### Component 2

- Change C

## Affected Areas

- [**] Frontend components: [list]
- [**] Backend endpoints: [list]
- [**] Global state: [list]
- [**] Types/Interfaces: [list]

## Verification Plan

- [**] Test case 1
- [**] Test case 2
```

### 4. Services Layer Management

- **ALWAYS** check API services before modifying endpoint calls
- Verify service layer matches backend endpoints
- Update service types if endpoint changes
- Check all components using the service
- after make new file or folder update to .clinerules

**Service layer checklist:**

```
[**] Check src/app/services/ for API service functions
[**] Verify service layer matches backend endpoints
[**] Update service types if endpoint changes
[**] Check all components using the service
[**] Test service error handling
[**] Cloudflare Workers (TypeScript/Hono)
```

### 5. Middleware & Auth Changes

- **ALWAYS** check middleware when modifying authentication
- Verify auth middleware logic in backend
- Test protected endpoints after changes
- Update route guards if needed

**Middleware checklist:**

```
[**] Check cloude-flare-wancash/src/middleware.ts
[**] Verify auth middleware logic
[**] Test protected endpoints
[**] Update route guards if needed
[**] Check CORS configuration
```

---

## ğŸ“ Project Structure

### Frontend (`/my-frontend/src`)

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ auth/              # Auth-related utilities
â”‚   â”œâ”€â”€ components/        # Shared app components (19 files)
â”‚   â”œâ”€â”€ composables/       # Vue composables (6 files)
â”‚   â”‚   â”œâ”€â”€ useAuth.ts     # Main authentication logic
â”‚   â”‚   â”œâ”€â”€ useWallet.ts   # Wallet connection
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ layout/            # Layout components
â”‚   â”œâ”€â”€ router/            # Vue Router config & guards
â”‚   â”‚   â””â”€â”€ index.ts       # Route definitions & auth guards
â”‚   â”œâ”€â”€ services/          # API services layer (8 files)
â”‚   â”‚   â”œâ”€â”€ authService.ts
â”‚   â”‚   â”œâ”€â”€ transactionService.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ stores/            # App-level Pinia stores (3 files)
â”œâ”€â”€ components/            # Main UI components (126 files)
â”œâ”€â”€ modules/               # Feature modules (146 files)
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ portfolio/
â”‚   â”œâ”€â”€ bridge/
â”‚   â”œâ”€â”€ redemption/
â”‚   â””â”€â”€ admin/
â”œâ”€â”€ stores/                # Root Pinia store
â”œâ”€â”€ types/                 # TypeScript type definitions (4 files)
â”œâ”€â”€ utils/                 # Utility functions (6 files)
â”œâ”€â”€ shared/                # Shared utilities (4 files)
â””â”€â”€ lib/                   # External libraries config
```

### Backend (`/cloude-flare-wancash/src`)

```
src/
â”œâ”€â”€ index.ts              # Main router & CORS config
â”œâ”€â”€ auth.ts               # Authentication & authorization endpoints
â”œâ”€â”€ middleware.ts         # Auth middleware & request validation
â”œâ”€â”€ db.ts                 # D1 database configuration
â”œâ”€â”€ transactions.ts       # Transaction history endpoints
â”œâ”€â”€ redemption.ts         # Redemption management endpoints
â”œâ”€â”€ products.ts           # Product catalog endpoints
â”œâ”€â”€ profile.ts            # User profile management endpoints
â”œâ”€â”€ support.ts            # Support/help endpoints
â”œâ”€â”€ stats.ts              # Statistics & analytics endpoints
â””â”€â”€ addressBook.ts        # Address book management endpoints
```

### Backend API Endpoints

```typescript
// Authentication (auth.ts)
POST   /api/auth/nonce          # Get nonce for signing
POST   /api/auth/verify         # Verify signature & login
GET    /api/auth/refresh        # Refresh access token
POST   /api/auth/logout         # Logout & clear cookies
GET    /api/me                  # Get current user info

// Transactions (transactions.ts)
GET    /api/transactions        # Get transaction history
POST   /api/transactions        # Create new transaction

// Redemption (redemption.ts)
GET    /api/redemptions         # Get redemption history
POST   /api/redemptions         # Create redemption request
PATCH  /api/redemptions/:id     # Update redemption status (admin)

// Products (products.ts)
GET    /api/products            # Get product catalog

// Profile (profile.ts)
GET    /api/profile             # Get user profile
PUT    /api/profile             # Update user profile

// Support (support.ts)
GET    /api/support             # Get support tickets
POST   /api/support             # Create support ticket

// Stats (stats.ts)
GET    /api/stats               # Get platform statistics

// Address Book (addressBook.ts)
GET    /api/address-book        # Get saved addresses
POST   /api/address-book        # Add new address
```

---

## ğŸ” Pre-Change Checklist

Before making ANY code change:

### For Variable Changes:

1. âœ… Search for all usages: `grep_search` with variable name
2. âœ… Check if it's a global state (Pinia store, composable)
3. âœ… Identify all consumers (components, other composables)
4. âœ… Verify reactive dependencies
5. âœ… Plan updates for all affected files

### For API Endpoint Changes:

1. âœ… Search frontend for endpoint usage: `grep_search` with endpoint path
2. âœ… Check backend route handler
3. âœ… Check services layer (src/app/services/)
4. âœ… Verify request/response types match
5. âœ… Check error handling on both sides
6. âœ… List all consumers that need updates
7. âœ… Plan synchronization strategy

### For Component Changes:

1. âœ… Check if component is used in multiple places
2. âœ… Verify props/emits contracts
3. âœ… Check parent-child dependencies
4. âœ… Test responsive design (mobile/desktop)

### For Dependency Changes:

1. âœ… Check existing dependencies for conflicts
2. âœ… Verify version compatibility
3. âœ… Test build after adding dependency
4. âœ… Update package.json and lock file

---

## ğŸš€ Development Workflow

### Step 1: Analysis

- Understand the requirement fully
- Ask clarifying questions if needed
- Identify all affected areas
- Check existing dependencies to synchronize

### Step 2: Planning

- Create `implementation_plan.md`
- List all files to be changed
- Identify potential risks
- Get user approval via `notify_user`

### Step 3: Implementation

- Make changes incrementally
- Follow the plan
- Update related files together
- Keep changes atomic and focused

### Step 4: Verification

- Test all affected functionality
- Verify no regressions
- Check console for errors
- Create `walkthrough.md` with results

---

## ğŸ› ï¸ Technology Stack

### Frontend

- **Framework**: Vue 3 (Composition API)
- **State**: Pinia stores + Composables
- **Router**: Vue Router
- **Wallet**: Wagmi + Web3Modal
- **UI**: Shadcn + Custom components + Tailwind CSS
- **Build**: Vite + Bun
- **Package Manager**: Bun

### Backend

- **Platform**: Cloudflare Workers
- **Database**: Neon database
- **Auth**: Cookie-based with JWT
- **Runtime**: Cloudflare Workers Runtime

---

## âš ï¸ Common Pitfalls to Avoid

1. **Don't** modify global variables without checking all usages
2. **Don't** change API contracts without updating all consumers
3. **Don't** skip the planning phase for complex changes
4. **Don't** make assumptions - always verify with grep/search
5. **Don't** forget to check both FE and BE when changing endpoints
6. **Don't** forget to check services layer when modifying API calls
7. **Don't** modify middleware without testing protected routes

---

## ğŸ“ Code Style Guidelines

### TypeScript

- Use explicit types for function parameters and returns
- Prefer `interface` over `type` for object shapes
- Use `const` for immutable values
- Use descriptive variable names
- Always use Bun for package management

### Vue Components

- Use Composition API with `<script setup>`
- Keep components focused and single-purpose
- Extract reusable logic to composables
- Use TypeScript for props and emits

### Naming Conventions

- Components: PascalCase (e.g., `UserProfile.vue`)
- Composables: camelCase with `use` prefix (e.g., `useAuth.ts`)
- Stores: camelCase with `Store` suffix (e.g., `userStore.ts`)
- Constants: UPPER_SNAKE_CASE

---

## ğŸ” Authentication Flow

Current implementation uses:

- Wagmi for wallet connection
- Cookie-based sessions (HttpOnly)
- Access tokens (4 min) + Refresh tokens (7 days)
- Proactive token refresh (1 min before expiry)
- Role-based access (user/admin)

**Key files:**

- `/src/app/composables/useAuth.ts` - Main auth logic
- `/src/app/router/index.ts` - Route guards
- Backend: `/cloude-flare-wancash/src/auth.ts` - Auth endpoints
- Backend: `/cloude-flare-wancash/src/middleware.ts` - Auth middleware

---

## ğŸ“‹ Example: Changing a Global Variable

```typescript
// âŒ WRONG - Direct change without checking
const isConnected = ref(false) // Changed from true

// âœ… CORRECT - Follow the process
// 1. Search for all usages
grep_search('isConnected', ['*.ts', '*.vue'])

// 2. Document findings
// Found in:
// - useAuth.ts (definition)
// - Header.vue (displays connection status)
// - WalletButton.vue (enables/disables button)

// 3. Create plan
// - Update useAuth.ts logic
// - Verify Header.vue still works
// - Verify WalletButton.vue still works
// - Test connection flow

// 4. Get approval, then implement
```

---

## ğŸ“‹ Example: Changing an API Endpoint

```typescript
// Changing: POST /api/auth/verify

// âœ… CORRECT Process:
// 1. Search frontend usage
grep_search('/api/auth/verify', ['*.ts', '*.vue'])
// Found in: useAuth.ts line 186

// 2. Check services layer
// File: src/app/services/authService.ts

// 3. Check backend handler
// File: cloude-flare-wancash/src/auth.ts

// 4. Document contract
// Request: { address, signature, message, chainId }
// Response: { user, expiresIn }

// 5. Plan changes
// - Update backend handler (auth.ts)
// - Update service layer (authService.ts)
// - Update frontend call in useAuth.ts
// - Update TypeScript types
// - Test login flow

// 6. Get approval, implement, verify
```

---

## ğŸ¯ Remember

> **"Plan first, code second, verify always"**

Every change should follow this pattern:

1. ğŸ” **Search** - Find all affected code
2. ğŸ“‹ **Plan** - Document what will change
3. âœ… **Approve** - Get user confirmation
4. ğŸ› ï¸ **Implement** - Make the changes
5. âœ¨ **Verify** - Test everything works

---

_Last updated: 2026-01-12_
